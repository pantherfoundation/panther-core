import * as path from 'path';

import circom_wasm_tester from 'circom_tester';
const wasm_tester = circom_wasm_tester.wasm;

import {getOptions} from './helpers/circomTester';
import {wtns} from 'snarkjs';
import poseidon from 'circomlibjs/src/poseidon';
import {
    generateRandom256Bits,
    moduloBabyJubSubFieldPrime,
} from '@panther-core/crypto/lib/base/field-operations';
import {MerkleTree} from '@zk-kit/merkle-tree';
import assert from 'assert';
import {PublicKey} from '@panther-core/crypto/lib/types/keypair';

import {
    deriveChildPubKeyFromRootPubKey,
    deriveChildPrivKeyFromRootPrivKey,
    deriveKeypairFromSeed,
} from '@panther-core/crypto/lib/base/keypairs';

describe('Automated Market Maker - Non Zero Input Voucher Exchange - Witness computation', async function (this: any) {
    const poseidon2or3 = (inputs: bigint[]): bigint => {
        assert(inputs.length === 3 || inputs.length === 2);
        return poseidon(inputs);
    };

    let circuit: any;
    let ammWasm: any;
    let ammWitness: any;

    this.timeout(10000000);

    before(async () => {
        const opts = getOptions();
        const input = path.join(opts.basedir, './circuits/mainAmmV1.circom');
        circuit = await wasm_tester(input, opts);

        ammWasm = path.join(
            opts.basedir,
            './compiled/prpConverter/circuits.wasm',
        );

        ammWitness = path.join(opts.basedir, './compiled/generateWitness.js');
    });

    const zAccountUtxoInRootSpendPubKey: PublicKey = [
        9665449196631685092819410614052131494364846416353502155560380686439149087040n,
        13931233598534410991314026888239110837992015348186918500560502831191846288865n,
    ];

    const zAccountUtxoInSpendKeyRandom =
        2346914846639907011573200271264141030138356202571314043957571486189990605213n;

    /* START ===== zAccountUtxoInSpendPrivKey computation ===== */
    const deriveChildPrivKey = deriveChildPrivKeyFromRootPrivKey(
        1364957401031907147846036885962614753763820022581024524807608342937054566107n,
        2346914846639907011573200271264141030138356202571314043957571486189990605213n,
    );

    // 2000647208403813089996879169930475450547584088540869434526192256795751137198n
    // console.log('deriveChildPrivKey=>', deriveChildPrivKey);
    /* END ===== zAccountUtxoInSpendPrivKey computation ===== */

    /* START ===== ZAccountNullifierHasher computation ===== */
    const ZAccountNullifierHasher = poseidon([
        2081961849142627796057765042284889488177156119328724687723132407819597118232n,
        9775219500384962933792568081585395848317570806746644855790488573783186458332n,
    ]);

    // ZAccountNullifierHasher=> 1910645914508659881155319814080523578568656423596421584647090145587320433693n
    // console.log('ZAccountNullifierHasher=>', ZAccountNullifierHasher);
    /* END ===== ZAccountNullifierHasher computation ===== */

    /* START ===== zAccountUtxoOutSpendPubKey computation ===== */
    const zAccountUtxoOutSpendKeyRandom =
        185557730709061450306117592388043477299652441972445952549541952981196070710n;

    const zAccountUtxoOutDerivedPublicKeys = deriveChildPubKeyFromRootPubKey(
        zAccountUtxoInRootSpendPubKey,
        zAccountUtxoOutSpendKeyRandom,
    );

    // zAccountUtxoOutDerivedPublicKeys=> [
    //     15450901734967420267341970211135586307161675027852667654394805743325744413243n,
    //     17303859841980668443827403121432647728954263496862455938703664325104926808364n
    // ]
    // console.log(
    //     'zAccountUtxoOutDerivedPublicKeys=>',
    //     zAccountUtxoOutDerivedPublicKeys,
    // );
    const createTime = 1693306152n;

    const hash1ZAccountOut = poseidon([
        15450901734967420267341970211135586307161675027852667654394805743325744413243n, // zAccountUtxoOutDerivedPublicKeys[0]
        17303859841980668443827403121432647728954263496862455938703664325104926808364n, // zAccountUtxoOutDerivedPublicKeys[1]
        9665449196631685092819410614052131494364846416353502155560380686439149087040n, // zAccountUtxoInRootSpendPubKey[0]
        13931233598534410991314026888239110837992015348186918500560502831191846288865n, // zAccountUtxoInRootSpendPubKey[1]
        1187405049038689339917658225106283881019816002721396510889166170461283567874n, // readPubKeys[0]
        311986042833546580202940940143769849297540181368261575540657864271112079432n, // readPubKeys[1]
        18636161575160505712724711689946435964943204943778681265331835661113836693938n, // zAccountNullifierPubKeys[0]
        21369418187085352831313188453068285816400064790476280656092869887652115165947n, // zAccountNullifierPubKeys[1]
    ]);
    // 6421340279120939748820218434314559073614067668219837180665518481248463634759n
    // console.log('hash1ZAccountOut=>', hash1ZAccountOut);

    // zAccountUtxoInNoteHasher calculation
    const zAccountUtxoOutNoteHasher = poseidon([
        hash1ZAccountOut,
        407487970930055136132864974074225519407787604125n, // masterEOA
        33, // id
        9999990000, // amountZkp
        500, // amountPrp - change
        1, // zoneId
        1702652400, // expiryTime
        1, // nonce - change
        0, // totalAmountPerTimePeriod
        1693306152n, // createTime - change
        2, // networkId
    ]);

    // 9801583813274409579839703000557872896423943281169404264890046333778640256067n
    // console.log('zAccountUtxoOutNoteHasher=>', zAccountUtxoOutNoteHasher);
    /* END ===== zAccountUtxoOutSpendPubKey computation ===== */

    /* START ===== State of UTXO tree ===== */
    // ZAccountRegistration process will create 1 UTXO i.e ZAccountUTXO
    // This will be added to the BUS tree
    // Adding ZAccountUTXO created to the BUS tree
    const busMerkleTree = new MerkleTree(
        poseidon2or3,
        26,
        BigInt(
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,
        ),
    );
    // 12604557588521919493356492354767978894799472715473645550898984861352936983014n
    // console.log('busUTXOMerkleTree root=>', busMerkleTree.root);

    // zAccountUtxoInNoteHasher - 9775219500384962933792568081585395848317570806746644855790488573783186458332n
    const ZAccountRegistrationZAccOutUTXO =
        9775219500384962933792568081585395848317570806746644855790488573783186458332n;
    busMerkleTree.insert(ZAccountRegistrationZAccOutUTXO);
    // {
    //     root: 3715423866577673325095003808123486321728557565912179400539191807213701546516n,
    //     leaf: 9775219500384962933792568081585395848317570806746644855790488573783186458332n,
    //     siblingNodes: [
    //       2896678800030780677881716886212119387589061708732637213728415628433288554509n,
    //       15915358021544645824948763611506574620607002248967455613245207713011512736724n,
    //       3378776220260879286502089033253596247983977280165117209776494090180287943112n,
    //       13332607562825133358947880930907706925768730553195841232963500270946125500492n,
    //       2602133270707827583410190225239044634523625207877234879733211246465561970688n,
    //       19603150025355661252212198237607440386334054455687766589389473805115541553727n,
    //       21078238521337523625806977154031988767929399923323679789427062985634312723305n,
    //       15530836891415741166399860451702547522959094984965127719828675838122418186767n,
    //       17831836427614557290431652044145414371925087626131808598362009890774438652119n,
    //       4465836784202878977538296341471470300441964855135851519008900812038788261656n,
    //       12878033372712703816810492505815415858124057351499708737135229819203122809944n,
    //       18307780612008914306024415546812737365063691384665843671053755584619447524447n,
    //       18399220794236723308907532455368503933105202479015828179801520916772962880998n,
    //       17997772780903759195601581429183819619412163062353143936165307874482723961709n,
    //       18496693394049906980893311686550786982256672525298758106045562727433199943509n,
    //       12455859713696229724526221339047857485467607588813434501517928769317308134556n,
    //       4689866144310700684516443679096813921756239671572972966393880542662538400201n,
    //       15369835007378492529084633432655739856631861107309342928676871259240227049033n,
    //       11345121393552856548579926390199540849469635305183604045111689968777651956473n,
    //       11299066061427200562963422042645343948885353762628147353062799587547441871332n,
    //       13642291777448032365864888577168560039775015251774208221818005338405304930884n,
    //       5990068516814370380711726420154273589568095823652643357428323105329308577610n,
    //       3326440148296065541386325860294367616471601340115249960006624245213734239367n,
    //       17613623862311960463347469460117166104477522402420094872382418386742059442736n,
    //       16619835833299406266546819907603615045049052832835825671901337303713338780409n,
    //       15002435000641955406214223423745696701460524528446564760654584364314696565951n
    //     ],
    //     path: [
    //       0, 0, 0, 0, 0, 0, 0, 0,
    //       0, 0, 0, 0, 0, 0, 0, 0,
    //       0, 0, 0, 0, 0, 0, 0, 0,
    //       0, 0
    //     ]
    //   }
    // console.log(busMerkleTree.createProof(0));

    // Forest tree calculation
    const taxiMerkleRoot =
        21078238521337523625806977154031988767929399923323679789427062985634312723305n;

    const busMerkleRoot =
        3715423866577673325095003808123486321728557565912179400539191807213701546516n;

    const ferryMerkleRoot =
        16585547643065588372010718035675163508420403417446192422307560350739915741648n;

    const staticTreeMerkleRoot =
        15323795652282733476787593554593633163509524267163105218965028724899034265607n;

    const forestTree = poseidon([
        taxiMerkleRoot,
        busMerkleRoot,
        ferryMerkleRoot,
    ]);

    // Updated - 21797104496963892262884335320223742656647321711420251344379316478709925639367n
    // console.log('forestTree=>', forestTree);
    /* END ===== State of UTXO tree ===== */

    const nonZeroInput = {
        // external data anchoring
        extraInputsHash: 0,

        // zAsset
        zAssetId: 0,
        zAssetToken: 365481738974395054943628650313028055219811856521n,
        zAssetTokenId: 0,
        zAssetNetwork: 2,
        zAssetOffset: 0,
        zAssetWeight: 20,
        zAssetScale: 10 ** 12,
        zAssetMerkleRoot:
            19475268372719999722968422811919514831876197551539186448232606153745317203717n,

        zAssetPathIndices: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        zAssetPathElements: [
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,
            15530836891415741166399860451702547522959094984965127719828675838122418186767n,
            17831836427614557290431652044145414371925087626131808598362009890774438652119n,
            4465836784202878977538296341471470300441964855135851519008900812038788261656n,
            12878033372712703816810492505815415858124057351499708737135229819203122809944n,
            18307780612008914306024415546812737365063691384665843671053755584619447524447n,
            18399220794236723308907532455368503933105202479015828179801520916772962880998n,
            17997772780903759195601581429183819619412163062353143936165307874482723961709n,
            18496693394049906980893311686550786982256672525298758106045562727433199943509n,
            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
        ],

        chargedAmountZkp: 0n,
        addedAmountZkp: 0,
        zAccountUtxoInZkpAmount: 9999990000,
        zAccountUtxoOutZkpAmount: 9999990000,

        zAccountUtxoInSpendPrivKey:
            2000647208403813089996879169930475450547584088540869434526192256795751137198n,

        zAccountUtxoInRootSpendPubKey: [
            9665449196631685092819410614052131494364846416353502155560380686439149087040n,
            13931233598534410991314026888239110837992015348186918500560502831191846288865n,
        ],
        zAccountUtxoInSpendKeyRandom:
            2346914846639907011573200271264141030138356202571314043957571486189990605213n,

        zAccountUtxoInReadPubKey: [
            1187405049038689339917658225106283881019816002721396510889166170461283567874n,
            311986042833546580202940940143769849297540181368261575540657864271112079432n,
        ],
        zAccountUtxoInNullifierPubKey: [
            18636161575160505712724711689946435964943204943778681265331835661113836693938n,
            21369418187085352831313188453068285816400064790476280656092869887652115165947n,
        ],
        zAccountUtxoInNullifierPrivKey:
            2081961849142627796057765042284889488177156119328724687723132407819597118232n,

        zAccountUtxoInMasterEOA:
            407487970930055136132864974074225519407787604125n,
        zAccountUtxoInId: 33,
        zAccountUtxoInPrpAmount: 0,
        zAccountUtxoInZoneId: 1,
        zAccountUtxoInExpiryTime: 1702652400,
        zAccountUtxoInNonce: 0,
        zAccountUtxoInTotalAmountPerTimePeriod: 0,
        zAccountUtxoInCreateTime: 1692284400,
        zAccountUtxoInNetworkId: 2,

        zAccountUtxoInCommitment:
            9775219500384962933792568081585395848317570806746644855790488573783186458332n,

        zNetworkId: 2n,

        // Claimed voucher(vouchers) balance
        depositAmountPrp: 500,

        // For Voucher Exchange withdrawal of PRP is 0
        withdrawAmountPrp: 0,
        zAccountUtxoOutPrpAmount: 500,

        zAccountUtxoInNullifier:
            1910645914508659881155319814080523578568656423596421584647090145587320433693n,

        zAccountUtxoInMerkleTreeSelector: [1, 0],
        zAccountUtxoInPathIndices: [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0,
        ],
        zAccountUtxoInPathElements: [
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,
            15530836891415741166399860451702547522959094984965127719828675838122418186767n,
            17831836427614557290431652044145414371925087626131808598362009890774438652119n,
            4465836784202878977538296341471470300441964855135851519008900812038788261656n,
            12878033372712703816810492505815415858124057351499708737135229819203122809944n,
            18307780612008914306024415546812737365063691384665843671053755584619447524447n,
            18399220794236723308907532455368503933105202479015828179801520916772962880998n,
            17997772780903759195601581429183819619412163062353143936165307874482723961709n,
            18496693394049906980893311686550786982256672525298758106045562727433199943509n,
            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
            4689866144310700684516443679096813921756239671572972966393880542662538400201n,
            15369835007378492529084633432655739856631861107309342928676871259240227049033n,
            11345121393552856548579926390199540849469635305183604045111689968777651956473n,
            11299066061427200562963422042645343948885353762628147353062799587547441871332n,
            13642291777448032365864888577168560039775015251774208221818005338405304930884n,
            5990068516814370380711726420154273589568095823652643357428323105329308577610n,
            3326440148296065541386325860294367616471601340115249960006624245213734239367n,
            17613623862311960463347469460117166104477522402420094872382418386742059442736n,
            16619835833299406266546819907603615045049052832835825671901337303713338780409n,
            15002435000641955406214223423745696701460524528446564760654584364314696565951n,
            0,
            0,
            0,
            0,
            0,
            0,
        ],

        zAccountBlackListLeaf: 0,
        zAccountBlackListMerkleRoot:
            19217088683336594659449020493828377907203207941212636669271704950158751593251n,

        zAccountBlackListPathElements: [
            0n,
            14744269619966411208579211824598458697587494354926760081771325075741142829156n,
            7423237065226347324353380772367382631490014989348495481811164164159255474657n,
            11286972368698509976183087595462810875513684078608517520839298933882497716792n,
            3607627140608796879659380071776844901612302623152076817094415224584923813162n,
            19712377064642672829441595136074946683621277828620209496774504837737984048981n,
            20775607673010627194014556968476266066927294572720319469184847051418138353016n,
            3396914609616007258851405644437304192397291162432396347162513310381425243293n,
            21551820661461729022865262380882070649935529853313286572328683688269863701601n,
            6573136701248752079028194407151022595060682063033565181951145966236778420039n,
            12413880268183407374852357075976609371175688755676981206018884971008854919922n,
            14271763308400718165336499097156975241954733520325982997864342600795471836726n,
            20066985985293572387227381049700832219069292839614107140851619262827735677018n,
            9394776414966240069580838672673694685292165040808226440647796406499139370960n,
            11331146992410411304059858900317123658895005918277453009197229807340014528524n,
            15819538789928229930262697811477882737253464456578333862691129291651619515538n,
        ],
        zAccountUtxoOutSpendKeyRandom:
            185557730709061450306117592388043477299652441972445952549541952981196070710n,

        zAccountUtxoOutCommitment:
            9801583813274409579839703000557872896423943281169404264890046333778640256067n,

        // GMT: Tuesday, 29 August 2023 10:49:12
        createTime: 1693306152,

        utxoCommitment: 0,
        // Will be 0 as no ZAssetUTXO gets created during AMM voucher exchange tx
        utxoSpendPubKey: [0, 1],
        utxoSpendKeyRandom: 0,

        zZoneOriginZoneIDs: 1,
        zZoneTargetZoneIDs: 1,
        zZoneNetworkIDsBitMap: 5,
        zZoneTrustProvidersMerkleTreeLeafIDsAndRulesList: 1577058395,
        zZoneKycExpiryTime: 10368000, // 1 week epoch time
        zZoneKytExpiryTime: 86400,
        zZoneDepositMaxAmount: 1 * 10 ** 12,
        zZoneWithdrawMaxAmount: 1 * 10 ** 12,
        zZoneInternalMaxAmount: 1 * 10 ** 12,
        zZoneMerkleRoot:
            14189511324259672403799169204478898082389936563693111126414306380356116434465n,

        zZonePathElements: [
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,
            15530836891415741166399860451702547522959094984965127719828675838122418186767n,
            17831836427614557290431652044145414371925087626131808598362009890774438652119n,
            4465836784202878977538296341471470300441964855135851519008900812038788261656n,
            12878033372712703816810492505815415858124057351499708737135229819203122809944n,
            18307780612008914306024415546812737365063691384665843671053755584619447524447n,
            18399220794236723308907532455368503933105202479015828179801520916772962880998n,
            17997772780903759195601581429183819619412163062353143936165307874482723961709n,
            18496693394049906980893311686550786982256672525298758106045562727433199943509n,
            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
        ],
        zZonePathIndices: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        zZoneEdDsaPubKey: [
            13969057660566717294144404716327056489877917779406382026042873403164748884885n,
            11069452135192839850369824221357904553346382352990372044246668947825855305207n,
        ],
        zZoneZAccountIDsBlackList:
            1766847064778384329583297500742918515827483896875618958121606201292619775n,

        zZoneMaximumAmountPerTimePeriod: 1 * 10 ** 13,
        zZoneTimePeriodPerMaximumAmount: 86400,
        zZoneDataEscrowPubKey: [
            6461944716578528228684977568060282675957977975225218900939908264185798821478n,
            6315516704806822012759516718356378665240592543978605015143731597167737293922n,
        ],
        zZoneSealing: 1,

        zNetworkChainId: 80001,
        zNetworkIDsBitMap: 5,
        zNetworkTreeMerkleRoot:
            21448888980709764146265348599357914296432058767851940011937843763756766907579n,

        zNetworkTreePathElements: [
            17570133518121739548964196309665064125657253468811303682702000180123719703330n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
        ],
        zNetworkTreePathIndices: [1, 0, 0, 0, 0, 0],
        daoDataEscrowPubKey: [
            6744227429794550577826885407270460271570870592820358232166093139017217680114n,
            12531080428555376703723008094946927789381711849570844145043392510154357220479n,
        ],
        forTxReward: 10,
        forUtxoReward: 1828,
        forDepositReward: 57646075,

        trustProvidersMerkleRoot:
            675413191976636849763056983375622181122390331630387511499559599588194530856n,

        staticTreeMerkleRoot:
            17931067957218291153823825912158291535579397890455292055678506728658508421915n,

        forestMerkleRoot:
            21797104496963892262884335320223742656647321711420251344379316478709925639367n,

        taxiMerkleRoot:
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,

        busMerkleRoot:
            3715423866577673325095003808123486321728557565912179400539191807213701546516n,

        ferryMerkleRoot:
            16585547643065588372010718035675163508420403417446192422307560350739915741648n,

        // salt
        salt: 98765,
        saltHash:
            1035379174490095295757364370441431315669465777987680425354976294595527119016n,

        // magical constraint - groth16 attack: https://geometry.xyz/notebook/groth16-malleability
        magicalConstraint: 123456789,
    };

    it('should compute valid witness for zero input tx', async () => {
        await wtns.calculate(nonZeroInput, ammWasm, ammWitness, null);
        console.log('Witness calculation successful!');
    });
});
