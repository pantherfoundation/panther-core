import * as path from 'path';
import {toBeHex} from 'ethers';

import circom_wasm_tester from 'circom_tester';
const wasm_tester = circom_wasm_tester.wasm;

import {getOptions} from './helpers/circomTester';
import {wtns} from 'snarkjs';
import {poseidon, eddsa, babyjub} from 'circomlibjs';
import {
    generateRandom256Bits,
    moduloBabyJubSubFieldPrime,
} from '@panther-core/crypto/lib/base/field-operations';

import {deriveChildPubKeyFromRootPubKey} from '@panther-core/crypto/lib/base/keypairs';
import {PublicKey} from '@panther-core/crypto/lib/types/keypair';
import {bigIntToUint8Array, uint8ArrayToBigInt} from './helpers/utils';

// Scenario - KYC attestation for the current ZAccount has been expired. The ZAccount (User) needs to renew the ZAccount by providing a new KYC attestation.
describe('ZAccount Renewal - Non Zero Input - Witness computation', async function (this: any) {
    let circuit: any;
    let mainZAccountRenewalWasm: any;
    let mainZAccountRenewalWitness: any;

    this.timeout(10_000_000);

    before(async () => {
        const opts = getOptions();
        const input = path.join(
            opts.basedir,
            './circuits/mainZAccountRenewalV1.circom',
        );
        circuit = await wasm_tester(input, opts);

        mainZAccountRenewalWasm = path.join(
            opts.basedir,
            './compiled/zAccountRenewal/circuits.wasm',
        );

        mainZAccountRenewalWitness = path.join(
            opts.basedir,
            './compiled/generate_witness.js',
        );
    });

    /* START ===== zAccountUtxoInCommitment computation ===== */
    // computation of ZAccountUTXO
    // const zAccountUtxoInSpendKeyRandom = moduloBabyJubSubFieldPrime(
    //     generateRandom256Bits(),
    // );
    // console.log('zAccountUtxoInSpendKeyRandom=>', zAccountUtxoInSpendKeyRandom);

    const zAccountUtxoInSpendKeyRandom =
        2346914846639907011573200271264141030138356202571314043957571486189990605213n;

    // derive spending keys
    const derivedSpendingPublicKeys = deriveChildPubKeyFromRootPubKey(
        [
            9665449196631685092819410614052131494364846416353502155560380686439149087040n,
            13931233598534410991314026888239110837992015348186918500560502831191846288865n,
        ],
        2346914846639907011573200271264141030138356202571314043957571486189990605213n,
    );
    // [
    //     11392870440665611384223443361093186915789163355528960804496290151264150404783n,
    //     1980602838353121356011317890644718979451459814539765591254831962186205314923n
    // ]
    // console.log('derivedSpendingPublicKeys=>', derivedSpendingPublicKeys);

    const ZAccountRenewalUTXOhash = poseidon([
        11392870440665611384223443361093186915789163355528960804496290151264150404783n,

        1980602838353121356011317890644718979451459814539765591254831962186205314923n,

        9665449196631685092819410614052131494364846416353502155560380686439149087040n,

        13931233598534410991314026888239110837992015348186918500560502831191846288865n,

        1187405049038689339917658225106283881019816002721396510889166170461283567874n,

        311986042833546580202940940143769849297540181368261575540657864271112079432n,

        18636161575160505712724711689946435964943204943778681265331835661113836693938n,

        21369418187085352831313188453068285816400064790476280656092869887652115165947n,
    ]);
    // console.log('ZAccountRenewalUTXOhash=>', ZAccountRenewalUTXOhash);

    const ZAccountUTXO = poseidon([
        ZAccountRenewalUTXOhash,
        407487970930055136132864974074225519407787604125n,
        33n,
        100000000n,
        0n,
        1n,
        1702652400n,
        0n,
        0n,
        1692284400n,
        2n,
    ]);
    // 19047992597093047336371215524754541878461093335047259582748851115004307254010n
    // console.log('ZAccountUTXO=>', ZAccountUTXO);
    /* END ===== zAccountUtxoInCommitment computation ===== */

    /* START ===== ZAccountNullifierHasher computation ===== */
    // ZAccountNullifierHasher computation
    const ZAccountNullifierHasher = poseidon([
        2081961849142627796057765042284889488177156119328724687723132407819597118232n,
        19047992597093047336371215524754541878461093335047259582748851115004307254010n,
    ]);

    // ZAccountNullifierHasher=> 14914857781069603067364359915237089909255680140753506997126505326724192453553n
    // console.log('ZAccountNullifierHasher=>', ZAccountNullifierHasher);
    /* END ===== ZAccountNullifierHasher computation ===== */

    /* START ===== zAccountUtxoOutCommitment computation ===== */
    // zAccountUtxoOutExpiryTime = zAccountUtxoOutCreateTime + zZoneKycExpiryTime;
    //           1702656400      =         1692284400        + 10368000n

    // computation of zAccountUtxoOutNoteHasher
    // zAccountUtxoOutSpendKeyRandom
    // const seed = moduloBabyJubSubFieldPrime(generateRandom256Bits());
    // console.log('seed=>', seed);
    const zAccountUtxoOutSpendKeyRandom =
        2503759497073117895347816779247320969972437443280664592062594608536584550965n;

    // derive spending keys
    const zAccountUtxoOutSpendPubKeys = deriveChildPubKeyFromRootPubKey(
        [
            9665449196631685092819410614052131494364846416353502155560380686439149087040n,
            13931233598534410991314026888239110837992015348186918500560502831191846288865n,
        ],
        2503759497073117895347816779247320969972437443280664592062594608536584550965n,
    );
    // zAccountUtxoOutSpendPubKeys=> [
    //     6633217571425594862134908011090026782386105823662480575418323948823005127022n,
    //     18880985813171714002417900000316316663854909244143206233036555162977335701995n
    //   ]
    // console.log('zAccountUtxoOutSpendPubKeys=>', zAccountUtxoOutSpendPubKeys);

    const ZAccountRenewalUTXOOuthash = poseidon([
        6633217571425594862134908011090026782386105823662480575418323948823005127022n,

        18880985813171714002417900000316316663854909244143206233036555162977335701995n,

        9665449196631685092819410614052131494364846416353502155560380686439149087040n,

        13931233598534410991314026888239110837992015348186918500560502831191846288865n,

        1187405049038689339917658225106283881019816002721396510889166170461283567874n,

        311986042833546580202940940143769849297540181368261575540657864271112079432n,

        18636161575160505712724711689946435964943204943778681265331835661113836693938n,

        21369418187085352831313188453068285816400064790476280656092869887652115165947n,
    ]);
    // console.log('ZAccountRenewalUTXOhash=>', ZAccountRenewalUTXOhash);

    const ZAccountRenewalUTXOOut = poseidon([
        ZAccountRenewalUTXOOuthash,
        407487970930055136132864974074225519407787604125n,
        33,
        99999000,
        0,
        1,
        1702656400,
        1,
        0,
        1692288400,
        2,
    ]);
    // 18637039208228158888837734245741621648425744122070932447721041976882941222441n
    // console.log('ZAccountRenewalUTXOOut=>', ZAccountRenewalUTXOOut);
    /* END ===== zAccountUtxoOutCommitment computation ===== */

    /* START ===== kycSignedMessageHashInternal calculation ===== */
    const kycSignedMessagePackageType = BigInt(1);
    const kycSignedMessageTimestamp = BigInt(1700040650n);

    const kycSignedMessageSender =
        BigInt(407487970930055136132864974074225519407787604125n);
    const kycSignedMessageSigner =
        BigInt(407487970930055136132864974074225519407787604125n);
    const kycSignedMessageReceiver =
        BigInt(0xfdfd920f2152565e9d7b589e4e9faee6699ad4bdn);
    const kycSignedMessageSessionId = toBeHex(1_000_000);
    const kycSignedMessageRuleId = BigInt(91);

    const sessionId = uint8ArrayToBigInt(
        bigIntToUint8Array(BigInt(kycSignedMessageSessionId), 32).slice(0, 31),
    );
    // console.log('sessionId=>', sessionId); //3906n

    // 6034194261754299281155503217674551331783912633604032814568402206279157838412n
    const kycSignedMessageHashInternal = poseidon([
        kycSignedMessagePackageType,
        kycSignedMessageTimestamp,
        kycSignedMessageSender,
        kycSignedMessageReceiver,
        sessionId,
        kycSignedMessageRuleId,
        kycSignedMessageSigner,
    ]);

    // console.log('kycSignedMessageHashInternal=>', kycSignedMessageHashInternal);
    // private key - purefi
    const prvKey = Buffer.from(
        '0102030405060708090001020304050607080900010203040506070809000102',
        'hex',
    );

    const pubKey = eddsa.prv2pub(prvKey);
    // 12245681108156315862721578421537205412164963293078065541324995831326019830563n
    const kycEdDsaPubKey0 = pubKey[0];

    // 3850804844767147361944551138681828170238733301762589784617578364038335435190n
    const kycEdDsaPubKey1 = pubKey[1];

    const signature = eddsa.signPoseidon(prvKey, kycSignedMessageHashInternal);

    // signature=> {
    //     R8: [
    //       16590765397609422238632074689051779736628424960204330294991066431201090184646n,
    //       21829746206346616319794155734503799899797944312552920032658662509096035110715n
    //     ],
    //     S: 2425607054711425321292767094874913634676093732638786371864372002385481755950n
    //   }
    // console.log('signature=>', signature);
    /* END ===== kycSignedMessageHashInternal calculator ===== */

    const nonZeroInput = {
        extraInputsHash: 0,
        addedAmountZkp: 0,
        chargedAmountZkp: 10 ** 15,

        zAssetId: 0,
        zAssetToken: 365481738974395054943628650313028055219811856521n,
        zAssetTokenId: 0,
        zAssetNetwork: 2,
        zAssetOffset: 0,
        zAssetWeight: 1,
        zAssetScale: 10 ** 12,
        zAssetMerkleRoot:
            21135153704249495390826690606677237922449975076652949796562023680187218995691n,
        zAssetPathIndices: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        zAssetPathElements: [
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,

            15915358021544645824948763611506574620607002248967455613245207713011512736724n,

            3378776220260879286502089033253596247983977280165117209776494090180287943112n,

            13332607562825133358947880930907706925768730553195841232963500270946125500492n,

            2602133270707827583410190225239044634523625207877234879733211246465561970688n,

            19603150025355661252212198237607440386334054455687766589389473805115541553727n,

            21078238521337523625806977154031988767929399923323679789427062985634312723305n,

            15530836891415741166399860451702547522959094984965127719828675838122418186767n,

            17831836427614557290431652044145414371925087626131808598362009890774438652119n,

            4465836784202878977538296341471470300441964855135851519008900812038788261656n,

            12878033372712703816810492505815415858124057351499708737135229819203122809944n,

            18307780612008914306024415546812737365063691384665843671053755584619447524447n,

            18399220794236723308907532455368503933105202479015828179801520916772962880998n,

            17997772780903759195601581429183819619412163062353143936165307874482723961709n,

            18496693394049906980893311686550786982256672525298758106045562727433199943509n,

            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
        ],

        zAccountUtxoInRootSpendPrivKey:
            1364957401031907147846036885962614753763820022581024524807608342937054566107n,
        zAccountUtxoInRootSpendPubKey: [
            9665449196631685092819410614052131494364846416353502155560380686439149087040n,
            13931233598534410991314026888239110837992015348186918500560502831191846288865n,
        ],
        zAccountUtxoInSpendKeyRandom:
            2346914846639907011573200271264141030138356202571314043957571486189990605213n,
        zAccountUtxoInReadPubKey: [
            1187405049038689339917658225106283881019816002721396510889166170461283567874n,
            311986042833546580202940940143769849297540181368261575540657864271112079432n,
        ],
        zAccountUtxoInNullifierPubKey: [
            18636161575160505712724711689946435964943204943778681265331835661113836693938n,
            21369418187085352831313188453068285816400064790476280656092869887652115165947n,
        ],
        zAccountUtxoInNullifierPrivKey:
            2081961849142627796057765042284889488177156119328724687723132407819597118232n,
        zAccountUtxoInMerkleTreeSelector: [1, 0],
        zAccountUtxoInPathIndices: [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0,
        ],
        zAccountUtxoInPathElements: [
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,
            15530836891415741166399860451702547522959094984965127719828675838122418186767n,
            17831836427614557290431652044145414371925087626131808598362009890774438652119n,
            4465836784202878977538296341471470300441964855135851519008900812038788261656n,
            12878033372712703816810492505815415858124057351499708737135229819203122809944n,
            18307780612008914306024415546812737365063691384665843671053755584619447524447n,
            18399220794236723308907532455368503933105202479015828179801520916772962880998n,
            17997772780903759195601581429183819619412163062353143936165307874482723961709n,
            18496693394049906980893311686550786982256672525298758106045562727433199943509n,
            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
            4689866144310700684516443679096813921756239671572972966393880542662538400201n,
            15369835007378492529084633432655739856631861107309342928676871259240227049033n,
            11345121393552856548579926390199540849469635305183604045111689968777651956473n,
            11299066061427200562963422042645343948885353762628147353062799587547441871332n,
            13642291777448032365864888577168560039775015251774208221818005338405304930884n,
            5990068516814370380711726420154273589568095823652643357428323105329308577610n,
            3326440148296065541386325860294367616471601340115249960006624245213734239367n,
            17613623862311960463347469460117166104477522402420094872382418386742059442736n,
            16619835833299406266546819907603615045049052832835825671901337303713338780409n,
            15002435000641955406214223423745696701460524528446564760654584364314696565951n,
            0,
            0,
            0,
            0,
            0,
            0,
        ],

        zAccountUtxoInMasterEOA:
            407487970930055136132864974074225519407787604125n,
        zAccountUtxoInId: 33,
        zAccountUtxoInZkpAmount: 100000000,
        zAccountUtxoInPrpAmount: 0,
        zAccountUtxoInZoneId: 1,
        zAccountUtxoInExpiryTime: 1702652400,
        zAccountUtxoInNonce: 0,
        zAccountUtxoInTotalAmountPerTimePeriod: 0,
        zAccountUtxoInCreateTime: 1692284400,
        zAccountUtxoInNetworkId: 2,

        zNetworkId: 2,
        zAccountUtxoInCommitment:
            19047992597093047336371215524754541878461093335047259582748851115004307254010n,

        zAccountUtxoInNullifier:
            14914857781069603067364359915237089909255680140753506997126505326724192453553n,
        zAccountUtxoOutZkpAmount: 99999000,
        zAccountBlackListLeaf: 0,
        zAccountBlackListMerkleRoot:
            19217088683336594659449020493828377907203207941212636669271704950158751593251n,
        zAccountBlackListPathElements: [
            0n,

            14744269619966411208579211824598458697587494354926760081771325075741142829156n,

            7423237065226347324353380772367382631490014989348495481811164164159255474657n,

            11286972368698509976183087595462810875513684078608517520839298933882497716792n,

            3607627140608796879659380071776844901612302623152076817094415224584923813162n,

            19712377064642672829441595136074946683621277828620209496774504837737984048981n,

            20775607673010627194014556968476266066927294572720319469184847051418138353016n,

            3396914609616007258851405644437304192397291162432396347162513310381425243293n,

            21551820661461729022865262380882070649935529853313286572328683688269863701601n,

            6573136701248752079028194407151022595060682063033565181951145966236778420039n,

            12413880268183407374852357075976609371175688755676981206018884971008854919922n,

            14271763308400718165336499097156975241954733520325982997864342600795471836726n,

            20066985985293572387227381049700832219069292839614107140851619262827735677018n,

            9394776414966240069580838672673694685292165040808226440647796406499139370960n,

            11331146992410411304059858900317123658895005918277453009197229807340014528524n,

            15819538789928229930262697811477882737253464456578333862691129291651619515538n,
        ],

        zAccountUtxoOutSpendKeyRandom:
            2503759497073117895347816779247320969972437443280664592062594608536584550965n,
        zAccountUtxoOutExpiryTime: 1702656400, // zAccountUtxoOutExpiryTime = zAccountUtxoOutCreateTime + zZoneKycExpiryTime;
        zAccountUtxoOutCreateTime: 1692288400,

        zZoneKycExpiryTime: 10368000n,
        zAccountUtxoOutCommitment:
            18637039208228158888837734245741621648425744122070932447721041976882941222441n,

        kycSignedMessagePackageType: 1,
        kycSignedMessageTimestamp: 1700040650,
        kycSignedMessageSender:
            407487970930055136132864974074225519407787604125n,
        kycSignedMessageReceiver: 0xfdfd920f2152565e9d7b589e4e9faee6699ad4bdn,
        kycSignedMessageSessionId: 3906,
        kycSignedMessageRuleId: 91,
        kycSignedMessageSigner:
            407487970930055136132864974074225519407787604125n,

        trustProvidersMerkleRoot:
            17776026177656288798445738250418845073931165171909516233447108979984337123087n,
        kycEdDsaPubKey: [
            12245681108156315862721578421537205412164963293078065541324995831326019830563n,
            3850804844767147361944551138681828170238733301762589784617578364038335435190n,
        ],
        kycSignature: [
            2425607054711425321292767094874913634676093732638786371864372002385481755950n,
            16590765397609422238632074689051779736628424960204330294991066431201090184646n,
            21829746206346616319794155734503799899797944312552920032658662509096035110715n,
        ],
        kycSignedMessageHash:
            6034194261754299281155503217674551331783912633604032814568402206279157838412n,
        kycEdDsaPubKeyExpiryTime: 1735689600,

        kycPathElements: [
            17016695977491387975747777387951291558575480655001270966217001764099828994492n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,
            15530836891415741166399860451702547522959094984965127719828675838122418186767n,
            17831836427614557290431652044145414371925087626131808598362009890774438652119n,
            4465836784202878977538296341471470300441964855135851519008900812038788261656n,
            12878033372712703816810492505815415858124057351499708737135229819203122809944n,
            18307780612008914306024415546812737365063691384665843671053755584619447524447n,
            18399220794236723308907532455368503933105202479015828179801520916772962880998n,
            17997772780903759195601581429183819619412163062353143936165307874482723961709n,
            18496693394049906980893311686550786982256672525298758106045562727433199943509n,
            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
        ],
        kycPathIndices: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        zZoneTrustProvidersMerkleTreeLeafIDsAndRulesList: 91,
        kycMerkleTreeLeafIDsAndRulesOffset: 0,

        zZoneEdDsaPubKey: [
            1079947189093879423832572021742411110959706509214994525945407912687412115152n,
            6617854811593651784376273094293148407007707755076821057553730151008062424747n,
        ],
        zZoneOriginZoneIDs: 1,
        zZoneTargetZoneIDs: 1,
        zZoneNetworkIDsBitMap: 3,
        zZoneKytExpiryTime: 86400,
        zZoneDepositMaxAmount: 5 * 10 ** 10,
        zZoneWithrawMaxAmount: 5 * 10 ** 10,
        zZoneInternalMaxAmount: 5 * 10 ** 12,
        zZoneZAccountIDsBlackList:
            1766847064778384329583297500742918515827483896875618958121606201292619775n,
        zZoneMaximumAmountPerTimePeriod: 5 * 10 ** 14,
        zZoneTimePeriodPerMaximumAmount: 86400,

        zZonePathElements: [
            2896678800030780677881716886212119387589061708732637213728415628433288554509n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
            21078238521337523625806977154031988767929399923323679789427062985634312723305n,
            15530836891415741166399860451702547522959094984965127719828675838122418186767n,
            17831836427614557290431652044145414371925087626131808598362009890774438652119n,
            4465836784202878977538296341471470300441964855135851519008900812038788261656n,
            12878033372712703816810492505815415858124057351499708737135229819203122809944n,
            18307780612008914306024415546812737365063691384665843671053755584619447524447n,
            18399220794236723308907532455368503933105202479015828179801520916772962880998n,
            17997772780903759195601581429183819619412163062353143936165307874482723961709n,
            18496693394049906980893311686550786982256672525298758106045562727433199943509n,
            12455859713696229724526221339047857485467607588813434501517928769317308134556n,
        ],
        zZonePathIndices: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        zNetworkChainId: 80001,
        zNetworkIDsBitMap: 3,
        forTxReward: 0,
        forUtxoReward: 1000,
        forDepositReward: 0,

        daoDataEscrowPubKey: [
            12272087043529289524334796370800745508281317430063431496260996322077559426628n,

            9194872949126287643523554866093178264045906284036198776275995684726142899669n,
        ],
        zNetworkTreeMerkleRoot:
            14012219796450685573713237305847642356367283250649627741328974142691321346497n,

        zNetworkTreePathElements: [
            13600883386059764494059343531292624452055533199459734774067365206557455126217n,
            15915358021544645824948763611506574620607002248967455613245207713011512736724n,
            3378776220260879286502089033253596247983977280165117209776494090180287943112n,
            13332607562825133358947880930907706925768730553195841232963500270946125500492n,
            2602133270707827583410190225239044634523625207877234879733211246465561970688n,
            19603150025355661252212198237607440386334054455687766589389473805115541553727n,
        ],
        zNetworkTreePathIndices: [1, 0, 0, 0, 0, 0],

        zZoneMerkleRoot:
            2768686232753548194788154003002220124197365245281377680762459495658913308970n,
        staticTreeMerkleRoot:
            2321398877276501093804987746752913907619636266114014064168961796133692819230n,

        forestMerkleRoot: 0,
        taxiMerkleRoot: 0,
        busMerkleRoot:
            7469082661021598578966721342957393849554121759963614277226594020362804260472n,
        ferryMerkleRoot: 0,

        salt: 0,
        saltHash: 0,
        magicalConstraint: 0,
    };

    it('should compute valid witness for non zero input tx', async () => {
        await wtns.calculate(
            nonZeroInput,
            mainZAccountRenewalWasm,
            mainZAccountRenewalWitness,
            null,
        );
        console.log('Witness calculation successful!');
    });
});
